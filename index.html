<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥­å‹™è¡Œå‹•æ¥å–®ç³»çµ± Pro</title>
    <!-- å¼•å…¥ Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* è‡ªå®šç¾© CSS */
        body {
            background-color: #f0f2f5;
            padding-bottom: 140px;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .sticky-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            padding: 15px;
            z-index: 1000;
        }

        .card {
            margin-bottom: 15px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 16px;
            overflow: hidden;
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 700;
            color: #2c3e50;
            padding: 1rem;
        }

        .price-text {
            color: #0d6efd;
            font-weight: bold;
        }
        
        /* æ¨¡å¼åˆ‡æ›é–‹é—œ */
        .mode-switch .btn-check:checked + .btn {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .mode-switch .btn {
            border-radius: 20px;
            padding: 0.3rem 1rem;
            font-size: 0.9rem;
        }

        /* æƒææŒ‰éˆ•å®šä½ */
        .scan-btn-wrapper {
            position: absolute;
            right: 15px;
            top: 10px;
            z-index: 10;
        }
    </style>
    <!-- å¼•å…¥ Google GenAI SDK (ä¿®æ­£ importmapï¼Œç§»é™¤ä¸å¿…è¦çš„ React) -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <!-- å°è¦½åˆ— -->
    <nav class="navbar navbar-dark bg-primary mb-3 shadow-sm">
        <div class="container-fluid justify-content-between" style="max-width: 600px;">
            <span class="navbar-brand mb-0 h1 fw-bold"><i class="bi bi-briefcase-fill me-2"></i>æ¥­å‹™æ¥å–® Pro</span>
            <button class="btn btn-sm btn-outline-light" onclick="openSettingsModal()" title="è¨­å®š">
                <i class="bi bi-gear-fill"></i> è¨­å®š
            </button>
        </div>
    </nav>

    <div class="container" style="max-width: 600px;">

        <!-- å ±åƒ¹æ¨¡å¼åˆ‡æ› -->
        <div class="d-flex justify-content-center mb-3 mode-switch bg-white p-2 rounded-pill shadow-sm mx-auto" style="width: fit-content;">
            <input type="radio" class="btn-check" name="priceMode" id="modeDirect" value="direct" checked onchange="handleModeChange()">
            <label class="btn btn-outline-secondary border-0" for="modeDirect">ç›´å®¢æ¨¡å¼</label>
            
            <input type="radio" class="btn-check" name="priceMode" id="modeDealer" value="dealer" onchange="handleModeChange()">
            <label class="btn btn-outline-secondary border-0" for="modeDealer">ç¶“éŠ·æ¨¡å¼</label>
        </div>
        
        <!-- å®¢æˆ¶è³‡è¨Šå€ -->
        <div class="card position-relative">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-person-vcard-fill me-2 text-primary"></i> å®¢æˆ¶è³‡è¨Š
                
                <!-- æƒææŒ‰éˆ• -->
                <div class="scan-btn-wrapper">
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageScan(this)">
                    <button class="btn btn-sm btn-warning text-dark fw-bold shadow-sm" onclick="document.getElementById('cameraInput').click()" id="scanBtn">
                        <i class="bi bi-camera-fill"></i> æƒåç‰‡
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="companyName" class="form-label text-muted small">å…¬å¸åç¨±</label>
                    <input type="text" class="form-control" id="companyName" placeholder="æƒææˆ–è¼¸å…¥å…¬å¸åç¨±">
                </div>
                <div class="mb-0">
                    <label for="customerName" class="form-label text-muted small">è¯çµ¡äººå§“å</label>
                    <input type="text" class="form-control" id="customerName" placeholder="æƒææˆ–è¼¸å…¥è¯çµ¡äºº">
                </div>
            </div>
        </div>

        <!-- ç”¢å“é¸æ“‡å€ -->
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-cart-plus-fill me-2 text-primary"></i> ç”¢å“é¸æ“‡
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="productSelect" class="form-label text-muted small">é¸æ“‡ç”¢å“</label>
                    <select class="form-select form-select-lg" id="productSelect" onchange="updatePricePreview()">
                        <option value="" selected disabled>-- è«‹é¸æ“‡ç”¢å“ --</option>
                    </select>
                    <div class="mt-2 text-end" id="pricePreview" style="font-size: 0.9rem; color: #6c757d; min-height: 20px;">
                        <!-- åƒ¹æ ¼æç¤ºé¡¯ç¤ºæ–¼æ­¤ -->
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-4">
                        <label for="quantity" class="form-label text-muted small">æ•¸é‡</label>
                        <input type="number" class="form-control form-control-lg text-center" id="quantity" value="1" min="1" oninput="updatePricePreview()">
                    </div>
                    <div class="col-8 d-flex align-items-end">
                        <button class="btn btn-primary btn-lg w-100 shadow-sm" id="addBtn">
                            <i class="bi bi-plus-lg"></i> åŠ å…¥æ¸…å–®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨‚å–®æ˜ç´°å€ -->
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <span><i class="bi bi-list-check me-2 text-primary"></i> è¨‚å–®æ˜ç´°</span>
                <span class="badge bg-light text-dark border" id="itemCountBadge">0 é …</span>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="orderList">
                    <li class="list-group-item text-center text-muted py-5" id="emptyMsg">
                        <i class="bi bi-basket display-6 d-block mb-3 opacity-25"></i>
                        å°šæœªåŠ å…¥ä»»ä½•å•†å“
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <!-- åº•éƒ¨å›ºå®šå€ -->
    <div class="sticky-bottom-bar">
        <div class="container" style="max-width: 600px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="h6 mb-0 text-secondary">ç¸½é‡‘é¡</span>
                <span class="h2 mb-0 price-text" id="totalAmount">$0</span>
            </div>
            <button class="btn btn-success w-100 py-2 fw-bold fs-5 shadow d-flex align-items-center justify-content-center gap-2" id="submitBtn">
                å»ºç«‹è¨‚å–®
            </button>
        </div>
    </div>

    <!-- è¨­å®š Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-sliders me-2"></i>ç³»çµ±è¨­å®š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tab å°èˆª -->
                    <ul class="nav nav-tabs mb-3" id="settingTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-content" type="button">ç”¢å“è³‡æ–™</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-content" type="button">API é€£ç·š</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <!-- ç”¢å“è³‡æ–™ Tab -->
                        <div class="tab-pane fade show active" id="data-content">
                            <div class="alert alert-info small p-2">
                                <strong>Excel åŒ¯å…¥èªªæ˜ï¼š</strong><br>
                                è«‹è¤‡è£½ Excel å…§å®¹ä¸¦è²¼ä¸Šåˆ°ä¸‹æ–¹ã€‚<br>
                                æ¬„ä½é †åºï¼š<code>ç”¢å“åç¨±, ç›´å®¢åƒ¹, ç¶“éŠ·åƒ¹(å–®), ç¶“éŠ·åƒ¹(æ‰¹), æ‰¹ç™¼é–€æª»</code>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">CSV è³‡æ–™ (æ¯è¡Œä¸€ç­†)</label>
                                <textarea class="form-control" id="csvInput" rows="10" style="font-family: monospace; font-size: 0.85rem; white-space: pre;"></textarea>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="restoreDefaultData()">æ¢å¾©é è¨­</button>
                                <button class="btn btn-primary" onclick="saveProductData()">å„²å­˜æ›´æ–°</button>
                            </div>
                        </div>

                        <!-- API é€£ç·š Tab -->
                        <div class="tab-pane fade" id="api-content">
                            <div class="mb-4">
                                <label class="form-label fw-bold">Google Apps Script ç¶²å€ (é€å–®ç”¨)</label>
                                <input type="text" class="form-control" id="gasUrlInput" placeholder="https://script.google.com/...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Gemini API Key (åç‰‡ OCR ç”¨)</label>
                                <input type="password" class="form-control" id="geminiKeyInput" placeholder="è²¼ä¸Šæ‚¨çš„ API Key">
                                <div class="form-text">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-decoration-none">ğŸ‘‰ é»æ­¤å–å¾—å…è²» API Key</a>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-primary" onclick="saveApiSettings()">å„²å­˜è¨­å®š</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // ==========================================
        // 1. è³‡æ–™èˆ‡ç‹€æ…‹ç®¡ç†
        // ==========================================
        
        // é è¨­ç¯„ä¾‹è³‡æ–™ (ç¬¦åˆæ‚¨çš„éœ€æ±‚æ ¼å¼)
        const DEFAULT_CSV = 
`Aç”¢å“ (æ¨™æº–å‹), 1000, 800, 700, 10
Bç”¢å“ (å°ˆæ¥­å‹), 2500, 2000, 1800, 5
Cç”¢å“ (æ——è‰¦å‹), 5000, 4000, 3500, 3
æ¶ˆè€—å“-æ¿¾ç¶², 500, 400, 300, 20`;

        let products = [];
        let orderItems = [];
        let currentMode = 'direct'; // 'direct' (ç›´å®¢) or 'dealer' (ç¶“éŠ·)
        
        // DOM å…ƒç´ å¿«å–
        const els = {
            companyName: document.getElementById('companyName'),
            customerName: document.getElementById('customerName'),
            productSelect: document.getElementById('productSelect'),
            quantityInput: document.getElementById('quantity'),
            addBtn: document.getElementById('addBtn'),
            orderList: document.getElementById('orderList'),
            emptyMsg: document.getElementById('emptyMsg'),
            totalAmount: document.getElementById('totalAmount'),
            submitBtn: document.getElementById('submitBtn'),
            scanBtn: document.getElementById('scanBtn'),
            pricePreview: document.getElementById('pricePreview'),
            csvInput: document.getElementById('csvInput'),
            gasUrlInput: document.getElementById('gasUrlInput'),
            geminiKeyInput: document.getElementById('geminiKeyInput'),
            modeRadios: document.getElementsByName('priceMode'),
            itemCountBadge: document.getElementById('itemCountBadge')
        };

        const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));

        // ==========================================
        // 2. åˆå§‹åŒ–èˆ‡è¨­å®šåŠŸèƒ½
        // ==========================================

        window.init = function() {
            loadSettings();
            
            // ç¶å®šäº‹ä»¶
            els.addBtn.addEventListener('click', handleAddItem);
            els.submitBtn.addEventListener('click', handleSubmit);
            
            // åˆå§‹åƒ¹æ ¼æ¨¡å¼
            const checked = document.querySelector('input[name="priceMode"]:checked');
            if (checked) currentMode = checked.value;
        }

        function loadSettings() {
            // è¼‰å…¥ç”¢å“è³‡æ–™
            const storedCsv = localStorage.getItem('product_csv');
            els.csvInput.value = storedCsv || DEFAULT_CSV;
            parseAndSetProducts(els.csvInput.value);

            // è¼‰å…¥ API è¨­å®š
            els.gasUrlInput.value = localStorage.getItem('gas_api_url') || '';
            els.geminiKeyInput.value = localStorage.getItem('gemini_api_key') || '';
        }

        // è§£æ CSV è½‰ç‚ºç”¢å“ç‰©ä»¶
        function parseAndSetProducts(csvText) {
            products = [];
            const lines = csvText.split('\n');
            
            lines.forEach((line, index) => {
                const cols = line.split(',').map(c => c.trim());
                // ç¢ºä¿è‡³å°‘æœ‰åç¨±å’Œä¸€å€‹åƒ¹æ ¼
                if (cols.length >= 2 && cols[0] !== "") {
                    products.push({
                        id: `p${index}`,
                        name: cols[0],
                        priceDirect: parseInt(cols[1]) || 0,
                        priceDealer: parseInt(cols[2]) || parseInt(cols[1]) || 0, // è‹¥ç„¡ç¶“éŠ·åƒ¹å‰‡åŒç›´å®¢åƒ¹
                        priceDealerBulk: parseInt(cols[3]) || parseInt(cols[2]) || 0,
                        bulkThreshold: parseInt(cols[4]) || 9999
                    });
                }
            });
            renderProductOptions();
        }

        window.openSettingsModal = function() {
            settingsModal.show();
        };

        window.saveProductData = function() {
            const csvText = els.csvInput.value.trim();
            localStorage.setItem('product_csv', csvText);
            parseAndSetProducts(csvText);
            alert('ç”¢å“è³‡æ–™å·²æ›´æ–°ï¼');
            settingsModal.hide();
        };

        window.restoreDefaultData = function() {
            if(confirm('ç¢ºå®šè¦æ¢å¾©é è¨­ç¯„ä¾‹è³‡æ–™å—ï¼Ÿç›®å‰è¼¸å…¥å°‡æœƒéºå¤±ã€‚')) {
                els.csvInput.value = DEFAULT_CSV;
            }
        };

        window.saveApiSettings = function() {
            localStorage.setItem('gas_api_url', els.gasUrlInput.value.trim());
            localStorage.setItem('gemini_api_key', els.geminiKeyInput.value.trim());
            alert('API è¨­å®šå·²å„²å­˜ï¼');
            settingsModal.hide();
        };

        // ==========================================
        // 3. æ ¸å¿ƒé‚è¼¯ (åƒ¹æ ¼è¨ˆç®—èˆ‡ UI)
        // ==========================================

        window.handleModeChange = function() {
            const checked = document.querySelector('input[name="priceMode"]:checked');
            currentMode = checked ? checked.value : 'direct';
            
            // é‡æ–°è¨ˆç®—è³¼ç‰©è»Šå…§æ‰€æœ‰åƒ¹æ ¼
            orderItems = orderItems.map(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    const newPrice = calculatePrice(product, item.quantity);
                    return {
                        ...item,
                        unitPrice: newPrice,
                        subtotal: newPrice * item.quantity
                    };
                }
                return item;
            });
            
            renderOrderList();
            updatePricePreview();
        };

        // åƒ¹æ ¼è¨ˆç®—å¼•æ“
        function calculatePrice(product, qty) {
            if (currentMode === 'direct') {
                return product.priceDirect;
            } else {
                // ç¶“éŠ·æ¨¡å¼ï¼šåˆ¤æ–·æ•¸é‡æ˜¯å¦é”åˆ°é–€æª»
                if (qty >= product.bulkThreshold && product.priceDealerBulk > 0) {
                    return product.priceDealerBulk;
                } else {
                    return product.priceDealer;
                }
            }
        }

        function renderProductOptions() {
            els.productSelect.innerHTML = '<option value="" selected disabled>-- è«‹é¸æ“‡ç”¢å“ --</option>';
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                els.productSelect.appendChild(option);
            });
        }

        window.updatePricePreview = function() {
            const productId = els.productSelect.value;
            const qty = parseInt(els.quantityInput.value) || 1;
            
            if (!productId) {
                els.pricePreview.textContent = '';
                return;
            }

            const product = products.find(p => p.id === productId);
            if (product) {
                const unitPrice = calculatePrice(product, qty);
                let text = '';
                if (currentMode === 'direct') {
                    text = `ç›´å®¢åƒ¹: $${unitPrice}`;
                } else {
                    if (qty >= product.bulkThreshold) {
                        text = `ğŸ”¥ ç¶“éŠ·å¤§é‡åƒ¹: $${unitPrice} (å·²é” ${product.bulkThreshold} å€‹)`;
                    } else {
                        text = `ç¶“éŠ·å–®æ©Ÿåƒ¹: $${unitPrice} (æ»¿ ${product.bulkThreshold} å€‹å¯äº«æ‰¹ç™¼åƒ¹)`;
                    }
                }
                els.pricePreview.innerHTML = text;
            }
        }

        function handleAddItem() {
            const productId = els.productSelect.value;
            const qty = parseInt(els.quantityInput.value);

            if (!productId) { alert('è«‹é¸æ“‡ä¸€é …ç”¢å“ï¼'); return; }
            if (!qty || qty <= 0) { alert('æ•¸é‡å¿…é ˆå¤§æ–¼ 0ï¼'); return; }

            const product = products.find(p => p.id === productId);
            if (!product) return;

            const unitPrice = calculatePrice(product, qty);
            
            const newItem = {
                productId: product.id,
                name: product.name,
                quantity: qty,
                unitPrice: unitPrice,
                subtotal: unitPrice * qty,
                uniqueId: Date.now().toString() + Math.random().toString(36).substr(2, 5)
            };

            orderItems.push(newItem);
            renderOrderList();
            
            // é‡ç½®é¸æ“‡
            els.productSelect.value = '';
            els.quantityInput.value = 1;
            els.pricePreview.textContent = '';
        }

        window.deleteItem = function(uniqueId) {
            if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) return;
            orderItems = orderItems.filter(item => item.uniqueId !== uniqueId);
            renderOrderList();
        };

        function renderOrderList() {
            els.orderList.innerHTML = '';
            els.itemCountBadge.textContent = `${orderItems.length} é …`;

            if (orderItems.length === 0) {
                els.orderList.appendChild(els.emptyMsg);
                els.emptyMsg.style.display = 'block';
                els.totalAmount.textContent = '$0';
                els.submitBtn.disabled = true;
                return;
            }
            
            els.emptyMsg.style.display = 'none';
            els.submitBtn.disabled = false;

            orderItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div class="flex-grow-1">
                        <div class="fw-bold text-dark">${item.name}</div>
                        <div class="text-muted small">
                            $${item.unitPrice.toLocaleString()} x <span class="badge bg-secondary rounded-pill">${item.quantity}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="price-text fw-bold mb-1">$${item.subtotal.toLocaleString()}</div>
                        <button class="btn btn-sm btn-link text-danger p-0 text-decoration-none" onclick="deleteItem('${item.uniqueId}')">
                            <i class="bi bi-trash"></i> ç§»é™¤
                        </button>
                    </div>
                `;
                els.orderList.appendChild(li);
            });

            const total = orderItems.reduce((acc, item) => acc + item.subtotal, 0);
            els.totalAmount.textContent = `$${total.toLocaleString()}`;
        }

        // ==========================================
        // 4. åç‰‡è¾¨è­˜ (Gemini API)
        // ==========================================

        window.handleImageScan = async function(input) {
            const file = input.files[0];
            if (!file) return;

            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                alert("âš ï¸ è«‹å…ˆè¨­å®š API Keyï¼\n\nè«‹é»æ“Šå³ä¸Šè§’ã€Œè¨­å®šã€ï¼Œåœ¨ API é€£ç·šåˆ†é ä¸­è²¼ä¸Šæ‚¨çš„ Gemini API Keyã€‚");
                input.value = ''; // æ¸…ç©º
                return;
            }

            // UI Loading ç‹€æ…‹
            const originalBtnHtml = els.scanBtn.innerHTML;
            els.scanBtn.disabled = true;
            els.scanBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> è¾¨è­˜ä¸­...`;

            try {
                // åœ–ç‰‡è½‰ Base64
                const base64Data = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                // å‘¼å« Gemini
                const ai = new GoogleGenAI({ apiKey: apiKey });
                
                // å®šç¾© Prompt
                const promptText = `
                    You are an OCR expert. Analyze this business card image.
                    Extract the "Company Name" and "Contact Person Name".
                    Return ONLY a JSON object. Do not format as markdown.
                    Structure: {"company": "...", "name": "..."}
                    If you cannot find one of them, return empty string.
                `;

                // ä¿®æ­£é‡é»ï¼šä½¿ç”¨ gemini-2.5-flash-latestï¼Œé€™æ˜¯ç›®å‰è¼ƒç©©å®šä¸”åŠŸèƒ½å¼·å¤§çš„ç‰ˆæœ¬
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash-latest', 
                    contents: {
                        parts: [
                            { text: promptText },
                            { inlineData: { mimeType: file.type, data: base64Data } }
                        ]
                    }
                });

                const responseText = response.text;
                console.log("Gemini Response:", responseText);

                if (!responseText) {
                    throw new Error("API å›å‚³å…§å®¹ç‚ºç©º");
                }

                // æ¸…ç†èˆ‡è§£æ JSON
                const cleanJson = responseText.replace(/```json|```/g, '').trim();
                let data;
                try {
                    data = JSON.parse(cleanJson);
                } catch (e) {
                    // è‹¥ JSON è§£æå¤±æ•—ï¼Œå˜—è©¦ç°¡å–®çš„æ­£å‰‡æå–
                    console.warn("JSON Parse failed, trying regex fallback");
                    const companyMatch = cleanJson.match(/"company"\s*:\s*"([^"]*)"/);
                    const nameMatch = cleanJson.match(/"name"\s*:\s*"([^"]*)"/);
                    data = {
                        company: companyMatch ? companyMatch[1] : "",
                        name: nameMatch ? nameMatch[1] : ""
                    };
                }

                if (data.company) els.companyName.value = data.company;
                if (data.name) els.customerName.value = data.name;
                
                alert(`âœ… è¾¨è­˜æˆåŠŸï¼\nå…¬å¸ï¼š${data.company || 'æœªåµæ¸¬åˆ°'}\nè¯çµ¡äººï¼š${data.name || 'æœªåµæ¸¬åˆ°'}`);

            } catch (error) {
                console.error("OCR Error:", error);
                
                // é‡å° Quota Exceeded (429) çµ¦äºˆå‹å–„æç¤º
                if (error.message.includes("429") || error.message.includes("Quota")) {
                     alert("â³ è¾¨è­˜å¤±æ•—ï¼šå…è²»ç‰ˆ API ä½¿ç”¨é‡å·²é”ä¸Šé™ã€‚\n\nè«‹ç¨å€™ï¼ˆç´„1-2åˆ†é˜ï¼‰å†è©¦ï¼Œæˆ–æ˜¯æ›´æ› API Keyã€‚");
                } else {
                     alert("âŒ è¾¨è­˜å¤±æ•—ï¼Œè«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºã€‚\néŒ¯èª¤è¨Šæ¯: " + error.message);
                }

            } finally {
                els.scanBtn.disabled = false;
                els.scanBtn.innerHTML = originalBtnHtml;
                input.value = ''; // æ¸…ç©ºä»¥åˆ©ä¸‹æ¬¡é¸æ“‡
            }
        };

        // ==========================================
        // 5. é€å‡ºè¨‚å–®
        // ==========================================
        
        function handleSubmit() {
            if (orderItems.length === 0) return;

            const company = els.companyName.value.trim();
            const contact = els.customerName.value.trim();

            if (!company && !contact) {
                alert('è«‹è‡³å°‘å¡«å¯«å…¬å¸åç¨±æˆ–è¯çµ¡äººå§“åï¼');
                return;
            }

            const apiUrl = localStorage.getItem('gas_api_url');
            if (!apiUrl) {
                alert("âš ï¸ æœªè¨­å®š GAS ç¶²å€ï¼\n\nè«‹è‡³è¨­å®šé é¢å¡«å¯« Google Apps Script ç¶²å€ï¼Œæ‰èƒ½å°‡è¨‚å–®é€å‡ºã€‚");
                openSettingsModal();
                return;
            }

            const total = orderItems.reduce((acc, item) => acc + item.subtotal, 0);
            
            // çµ„åˆè©³ç´°å…§å®¹
            let detailsStr = orderItems.map(item => 
                `${item.name} x${item.quantity} ($${item.unitPrice})`
            ).join("\n");
            
            // æ¨™è¨»æ¨¡å¼
            const modeText = currentMode === 'direct' ? 'ç›´å®¢' : 'ç¶“éŠ·';

            const orderData = {
                company: company,
                contact: contact,
                type: modeText, // æ–°å¢æ¬„ä½ï¼šå®¢æˆ¶é¡å‹
                amount: total,
                details: detailsStr,
                timestamp: new Date().toLocaleString()
            };

            // Loading
            const originalBtnText = els.submitBtn.innerHTML;
            els.submitBtn.disabled = true;
            els.submitBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span>å‚³é€ä¸­...</span>
            `;

            // POST
            fetch(apiUrl, {
                method: "POST",
                body: JSON.stringify(orderData),
                headers: { "Content-Type": "text/plain" } 
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`âœ… è¨‚å–®å·²å»ºç«‹ï¼\né‡‘é¡ï¼š$${total}\nå®¢æˆ¶ï¼š${company || contact}`);
                    resetForm();
                } else {
                    alert("âŒ å¾Œç«¯å›å‚³å¤±æ•—ï¼š" + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("âš ï¸ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API ç¶²å€ã€‚");
            })
            .finally(() => {
                els.submitBtn.disabled = false;
                els.submitBtn.innerHTML = originalBtnText;
            });
        }

        function resetForm() {
            orderItems = [];
            els.companyName.value = '';
            els.customerName.value = '';
            renderOrderList();
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>